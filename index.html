<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>QR Scanner Firebase</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body, html {
      margin: 0; padding: 0; font-family: Arial, sans-serif;
      height: 100%;
    }
    .hidden { display: none; }
    .view { padding: 20px; }
    #overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      display: none; 
      justify-content: center; align-items: center;
      font-size: 3em; color: white; z-index: 999; 
      flex-direction: column;
      text-align: center;
    }
    .overlay-green { background-color: #28a745; }
    .overlay-yellow { background-color: #ffc107; color: black; }
    .overlay-red { background-color: #dc3545; }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
    }
    #nextBtn {
      margin-top: 30px;
      padding: 10px 30px;
      font-size: 1em;
      display: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="overlay">
  <div id="overlayMessage"></div>
  <button id="nextBtn">Suivant</button>
</div>

<div id="homeView" class="view">
  <h1>Bienvenue</h1>
  <button onclick="showView('scanView')">📷 Scanner</button>
  <button onclick="showView('listView')">📋 Liste</button>
</div>

<div id="scanView" class="view hidden">
  <h1>Scanner un QR Code</h1>
  <div id="reader"></div>
  <p id="status">En attente de scan...</p>
  <button onclick="showView('homeView')">🔙 Retour</button>
</div>

<div id="listView" class="view hidden">
  <h1>Liste des QR attendus</h1>
  <ol id="codeList"></ol>
  <button onclick="resetAll()">🔁 Réinitialiser</button>
  <button onclick="showView('homeView')">🔙 Retour</button>
</div>

<script>
  // Remplace ces valeurs par ta config Firebase
  const firebaseConfig = {
    apiKey: "TON_API_KEY",
    authDomain: "TON_DOMAINE.firebaseapp.com",
    projectId: "TON_ID",
    storageBucket: "TON_BUCKET.appspot.com",
    messagingSenderId: "TON_ID",
    appId: "TON_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const validCodes = Array.from({ length: 15 }, (_, i) => (i + 1).toString());
  let scanningPaused = false;
  let overlayTimeout;

  const overlay = document.getElementById('overlay');
  const overlayMessage = document.getElementById('overlayMessage');
  const nextBtn = document.getElementById('nextBtn');
  const statusEl = document.getElementById('status');
  const html5QrCode = new Html5Qrcode("reader");

  function hideOverlay() {
    overlay.style.display = 'none';
    overlay.className = '';
    scanningPaused = false;
    statusEl.textContent = "En attente de scan...";
    nextBtn.style.display = 'none';
    overlayMessage.textContent = '';
    clearTimeout(overlayTimeout);
  }

  function showOverlay(message, className) {
    overlayMessage.textContent = message;
    overlay.className = className;
    overlay.style.display = 'flex';
    nextBtn.style.display = 'block';

    overlayTimeout = setTimeout(() => {
      hideOverlay();
    }, 5000);
  }

  nextBtn.addEventListener('click', () => {
    hideOverlay();
  });

  function updateListUI(code, status) {
    const li = document.querySelector(`li[data-code="${code}"]`);
    if (li) {
      const span = li.querySelector("span");
      span.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    }
  }

  async function onScanSuccess(decodedText) {
    if (scanningPaused) return;
    scanningPaused = true;

    if (!validCodes.includes(decodedText)) {
      showOverlay("❌ Refusé", "overlay-red");
      await db.collection("scans").doc(decodedText).set({ status: "refusé" });
      return;
    }

    const docRef = db.collection("scans").doc(decodedText);
    const doc = await docRef.get();

    if (!doc.exists) {
      showOverlay("✅ Autorisé", "overlay-green");
      await docRef.set({ status: "autorisé", timestamp: new Date() });
    } else {
      showOverlay("⚠️ Déjà scanné", "overlay-yellow");
    }
  }

  function resetAll() {
    validCodes.forEach(async (code) => {
      await db.collection("scans").doc(code).delete().catch(() => {});
    });
  }

  function showView(viewId) {
    document.querySelectorAll(".view").forEach(el => el.classList.add("hidden"));
    document.getElementById(viewId).classList.remove("hidden");

    if (viewId === "scanView") {
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess
      );
    } else {
      html5QrCode.stop().catch(() => {});
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    const listContainer = document.getElementById("codeList");
    validCodes.forEach(code => {
      const li = document.createElement("li");
      li.setAttribute("data-code", code);
      li.innerHTML = `${code} = <span>En attente</span>`;
      listContainer.appendChild(li);
    });

    db.collection("scans").onSnapshot(snapshot => {
      snapshot.forEach(doc => {
        const { status } = doc.data();
        updateListUI(doc.id, status);
      });
    });
  });
</script>

</body>
</html>
